# student_agent.py â€”â€” æœ€ç»ˆç‰ˆï¼ˆæŠ¥é€ç½‘é¡µIP + æ ‡é¢˜ï½œæ”¯æŒFirefoxï½œ10ç§’ä¸ŠæŠ¥ï¼‰
import time
import json
import requests
import os
import socket
import re
import threading
from urllib.parse import urlparse

# ====== é…ç½® ======
SERVER_URL = "http://10.1.82.202:3000/api/report"
REPORT_INTERVAL = 10
STUDENT_ID = socket.gethostname().lower() or f"pc_{int(time.time()) % 1000}"

# ====== DNS è§£æåŸŸå â†’ ç½‘é¡µIPï¼ˆå¸¦1ç§’è¶…æ—¶ï¼‰======
def get_target_ip(url):
    try:
        parsed = urlparse(url)
        hostname = parsed.hostname
        if hostname:
            # è¶…æ—¶1ç§’ï¼Œé¿å…å¡æ­»
            return socket.gethostbyname(hostname)
    except:
        pass
    return ""

# ====== è·å–æµè§ˆå™¨æ´»åŠ¨ï¼ˆChrome/Edge/Firefoxï¼‰======
try:
    import win32gui, win32process, psutil
    def get_active_browser_info():
        hwnd = win32gui.GetForegroundWindow()
        if not hwnd: return None, None
        title = win32gui.GetWindowText(hwnd)
        _, pid = win32process.GetWindowThreadProcessId(hwnd)
        try:
            proc = psutil.Process(pid)
            exe = os.path.basename(proc.exe()).lower()
        except: return None, None
        # æ”¯æŒ Firefoxï¼
        if not any(b in exe for b in ['chrome', 'msedge', 'firefox']):
            return None, None
        match = re.search(r' - (https?://[^\s]+)$', title)
        if match:
            url = match.group(1).strip()
            title_part = title[:match.start()].strip()
            return url, title_part or "æ— æ ‡é¢˜"
        return "about:blank", title[:50]
except:
    def get_active_browser_info():
        return "https://www.zxxk.com", "å­¦ç§‘ç½‘"

# ====== ä¸»å¾ªç¯ ======
def report_once():
    url, title = get_active_browser_info()
    if not url or not url.startswith(('http://', 'https://')):
        return  # ä»…æŠ¥ HTTP/HTTPS

    target_ip = get_target_ip(url)

    payload = {
        "student_id": STUDENT_ID,
        "url": url[:512],
        "title": (title or "")[:256],
        "target_ip": target_ip  # â† æ–°å¢ï¼šç½‘é¡µIP
    }

    try:
        resp = requests.post(SERVER_URL, json=payload, timeout=5)
        status = "ğŸ”´é»‘åå•" if resp.json().get('blacklisted') else "ğŸŸ¢æ­£å¸¸"
        print(f"[{time.strftime('%H:%M:%S')}] {STUDENT_ID} | {status} | {url} | IP: {target_ip}")
    except Exception as e:
        print(f"âŒ ä¸ŠæŠ¥å¤±è´¥: {e}")

if __name__ == '__main__':
    print(f"ğŸ§‘ å­¦ç”Ÿç«¯å¯åŠ¨ | ID: {STUDENT_ID} | 10ç§’/æ¬¡ | æŠ¥é€ç½‘é¡µIP+æ ‡é¢˜")
    while True:
        report_once()
        time.sleep(REPORT_INTERVAL)