# student_agent.py â€”â€” ä¸ŠæŠ¥åŸŸå+åŒä¸€åŸŸåå»é‡+æµè§ˆå™¨è¯†åˆ«ä¿®å¤
import time
import json
import requests
import os
import socket
import re
from urllib.parse import urlparse
import win32gui
import win32process
import psutil

# ====== é…ç½®é¡¹ ======
SERVER_URL = "http://10.1.82.202:3000/api/report"
REPORT_INTERVAL = 10  # åŸºç¡€ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰
DUPLICATE_INTERVAL = 30  # åŒä¸€åŸŸåé‡å¤ä¸ŠæŠ¥çš„é—´éš”ï¼ˆç§’ï¼Œå»ºè®®â‰¥30ï¼‰
STUDENT_ID = socket.gethostname().lower() or f"pc_{int(time.time()) % 1000}"

# å­˜å‚¨æœ€è¿‘ä¸ŠæŠ¥çš„åŸŸåï¼ˆkey=åŸŸåï¼Œvalue=æœ€åä¸ŠæŠ¥æ—¶é—´æˆ³ï¼‰
recent_domains = {}


# ====== 1. è·å–å­¦ç”Ÿç«¯IP ======
def get_student_ip():
    try:
        for addr_info in socket.getaddrinfo(socket.gethostname(), None):
            ip = addr_info[4][0]
            if ip.startswith(('10.', '192.168.', '172.')) and '.' in ip:
                return ip
        resp = requests.get("https://api.ipify.org?format=text", timeout=3)
        return resp.text.strip()
    except Exception:
        return "æœªçŸ¥IP"


# ====== 2. ä»URLæå–åŸŸåï¼ˆå»æ‰å‰ç¼€/è·¯å¾„ï¼‰======
def get_domain_from_url(url):
    """å°†å®Œæ•´URLè½¬æ¢ä¸ºåŸŸåï¼ˆå¦‚https://www.baidu.com/index â†’ baidu.comï¼‰"""
    if url in ["about:blank", "â€”"]:
        return "ç©ºç™½é¡µ/éç›®æ ‡æµè§ˆå™¨"
    try:
        parsed = urlparse(url)
        hostname = parsed.hostname
        if not hostname:
            return "æ— æ•ˆç½‘å€"
        
        # å»æ‰www/mç­‰å‰ç¼€ï¼Œä¿ç•™ä¸»åŸŸå
        prefixes = ["www", "m", "mobile", "wap", "web"]
        parts = hostname.split('.')
        if len(parts) >= 2 and parts[0] in prefixes:
            domain = '.'.join(parts[1:])
        else:
            domain = hostname
        return domain.lower()  # ç»Ÿä¸€å°å†™ï¼Œé¿å…å¤§å°å†™é‡å¤
    except Exception:
        return "æ— æ³•è§£æåŸŸå"


# ====== 3. æ ¹æ®åŸŸåè§£æç½‘é¡µIP ======
def get_target_ip(domain):
    if domain in ["ç©ºç™½é¡µ/éç›®æ ‡æµè§ˆå™¨", "æ— æ•ˆç½‘å€", "æ— æ³•è§£æåŸŸå"]:
        return "æœªçŸ¥IP"
    try:
        return socket.gethostbyname(domain)
    except Exception:
        return "æœªçŸ¥IP"


# ====== 4. æ­£ç¡®æå–Chrome/Edge/Firefoxçš„ç½‘å€ ======
def get_chrome_url(hwnd):
    """æå–Chromeåœ°å€æ ç½‘å€"""
    addr_class = 'Chrome_AutocompleteEditView'
    handles = []
    def enum_child(handle, extra):
        if win32gui.GetClassName(handle) == addr_class:
            extra.append(handle)
        win32gui.EnumChildWindows(handle, enum_child, extra)
    win32gui.EnumChildWindows(hwnd, enum_child, handles)
    return win32gui.GetWindowText(handles[0]).strip() if handles else None

def get_edge_url(hwnd):
    """æå–Edgeåœ°å€æ ç½‘å€"""
    edge_wins = []
    def find_edge(handle, extra):
        if win32gui.GetClassName(handle) == 'MicrosoftEdgeWindowClass':
            extra.append(handle)
        win32gui.EnumChildWindows(handle, find_edge, extra)
    win32gui.EnumChildWindows(hwnd, find_edge, edge_wins)
    if not edge_wins:
        return None
    
    addr_bars = []
    def find_addr(handle, extra):
        if win32gui.GetClassName(handle) == 'RichEditBox':
            extra.append(handle)
        win32gui.EnumChildWindows(handle, find_addr, extra)
    win32gui.EnumChildWindows(edge_wins[0], find_addr, addr_bars)
    return win32gui.GetWindowText(addr_bars[0]).strip() if addr_bars else None

def get_firefox_url(hwnd):
    """æå–Firefoxåœ°å€æ ç½‘å€"""
    addr_bars = []
    def enum_child(handle, extra):
        text = win32gui.GetWindowText(handle).strip()
        if win32gui.GetClassName(handle) == 'Edit' and text.startswith(('http://', 'https://')):
            extra.append(handle)
        win32gui.EnumChildWindows(handle, enum_child, extra)
    win32gui.EnumChildWindows(hwnd, enum_child, addr_bars)
    return win32gui.GetWindowText(addr_bars[0]).strip() if addr_bars else None


# ====== 5. è¯†åˆ«æµè§ˆå™¨å¹¶è·å–ç½‘å€/æ ‡é¢˜ ======
def get_active_browser_info():
    hwnd = win32gui.GetForegroundWindow()
    if not hwnd:
        return "about:blank", "æ— æ¿€æ´»çª—å£"
    
    window_title = win32gui.GetWindowText(hwnd)
    if not window_title:
        return "about:blank", "æ— çª—å£æ ‡é¢˜"
    
    # å‡†ç¡®è¯†åˆ«æµè§ˆå™¨è¿›ç¨‹
    _, pid = win32process.GetWindowThreadProcessId(hwnd)
    try:
        proc = psutil.Process(pid)
        exe = os.path.basename(proc.exe()).lower()
        valid_browsers = {
            'chrome.exe': ('chrome', get_chrome_url),
            'microsoftedge.exe': ('edge', get_edge_url),
            'firefox.exe': ('firefox', get_firefox_url)
        }
        if exe not in valid_browsers:
            return "about:blank", f"éç›®æ ‡æµè§ˆå™¨ï¼ˆ{exe}ï¼‰"
        _, get_url_func = valid_browsers[exe]
    except Exception as e:
        return "about:blank", f"è¿›ç¨‹å¼‚å¸¸ï¼š{str(e)[:50]}"
    
    # æå–å½“å‰ç½‘å€
    url = get_url_func(hwnd)
    if url:
        title = window_title.replace(f' - {proc.name().split(".")[0].capitalize()}', '').strip()
        return url, title
    else:
        return "about:blank", "æ— æ³•è·å–ç½‘å€"


# ====== 6. ä¸ŠæŠ¥é€»è¾‘ï¼ˆå«åŸŸåå»é‡ï¼‰======
def report_once():
    current_time = time.time()
    # 1. è·å–æµè§ˆå™¨æ•°æ®
    raw_url, title = get_active_browser_info()
    # 2. è½¬æ¢ä¸ºåŸŸå
    domain = get_domain_from_url(raw_url)
    # 3. åŒä¸€åŸŸåå»é‡ï¼ˆé—´éš”ä¸è¶³åˆ™è·³è¿‡ï¼‰
    if domain in recent_domains:
        if current_time - recent_domains[domain] < DUPLICATE_INTERVAL:
            print(f"[{time.strftime('%H:%M:%S')}] è·³è¿‡é‡å¤åŸŸåï¼š{domain}ï¼ˆé—´éš”ä¸è¶³{DUPLICATE_INTERVAL}ç§’ï¼‰")
            return
    # 4. æ›´æ–°æœ€è¿‘ä¸ŠæŠ¥è®°å½•ï¼ˆå¹¶æ¸…ç†1å°æ—¶å‰çš„æ—§è®°å½•ï¼‰
    recent_domains[domain] = current_time
    to_remove = [d for d, t in recent_domains.items() if current_time - t > 3600]
    for d in to_remove:
        del recent_domains[d]
    
    # 5. å…¶ä»–æ•°æ®
    student_ip = get_student_ip()
    target_ip = get_target_ip(domain)
    
    # 6. æ„é€ ä¸ŠæŠ¥æ•°æ®ï¼ˆurlå­—æ®µå­˜åŸŸåï¼‰
    payload = {
        "student_id": STUDENT_ID,
        "student_ip": student_ip,
        "url": domain,  # åŸURLå­—æ®µæ”¹ä¸ºå­˜å‚¨åŸŸå
        "title": title,
        "target_ip": target_ip
    }
    
    # 7. å‘é€ä¸ŠæŠ¥
    try:
        resp = requests.post(SERVER_URL, json=payload, timeout=5)
        resp_data = resp.json()
        status = "ğŸ”´é»‘åå•" if resp_data.get('blacklisted') else "ğŸŸ¢æ­£å¸¸"
        print(f"[{time.strftime('%H:%M:%S')}] {STUDENT_ID} | å­¦ç”ŸIP:{student_ip} | {status} | åŸŸå:{domain} | ç½‘é¡µIP:{target_ip}")
    except Exception as e:
        print(f"[{time.strftime('%H:%M:%S')}] âŒ ä¸ŠæŠ¥å¤±è´¥ï¼š{str(e)} | åŸŸå:{domain}")


# ====== ä¸»å¾ªç¯ ======
if __name__ == '__main__':
    print(f"ğŸ§‘ å­¦ç”Ÿç«¯å¯åŠ¨æˆåŠŸ | å­¦ç”ŸID: {STUDENT_ID} | è§„åˆ™ï¼šä¸ŠæŠ¥åŸŸå+{DUPLICATE_INTERVAL}ç§’å»é‡")
    print("="*80)
    while True:
        report_once()
        time.sleep(REPORT_INTERVAL)