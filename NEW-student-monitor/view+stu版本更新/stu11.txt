# student_agent.py â€”â€” ä¿®å¤æµè§ˆå™¨è¯†åˆ«+æ­£ç¡®æå–Chrome/Edge/Firefoxç½‘å€
import time
import json
import requests
import os
import socket
import re
from urllib.parse import urlparse
import win32gui
import win32process
import psutil

# ====== é…ç½® ======
SERVER_URL = "http://10.1.82.202:3000/api/report"
REPORT_INTERVAL = 10  # ä¸ŠæŠ¥é—´éš”ï¼ˆç§’ï¼‰
STUDENT_ID = socket.gethostname().lower() or f"pc_{int(time.time()) % 1000}"

# ====== 1. è·å–å­¦ç”Ÿç«¯IP ======
def get_student_ip():
    try:
        for addr_info in socket.getaddrinfo(socket.gethostname(), None):
            ip = addr_info[4][0]
            if ip.startswith(('10.', '192.168.', '172.')) and '.' in ip:
                return ip
        resp = requests.get("https://api.ipify.org?format=text", timeout=3)
        return resp.text.strip()
    except Exception:
        return "æœªçŸ¥IP"

# ====== 2. è·å–ç½‘é¡µIPï¼ˆåŸºäºæ­£ç¡®ç½‘å€ï¼‰======
def get_target_ip(url):
    try:
        parsed = urlparse(url)
        hostname = parsed.hostname
        if hostname:
            return socket.gethostbyname(hostname)
    except Exception:
        pass
    return "æœªçŸ¥IP"

# ====== 3. æµè§ˆå™¨ç½‘å€æå–å·¥å…·ï¼ˆåˆ†Chrome/Edge/Firefoxï¼‰======
def get_chrome_url(hwnd):
    """æå–Chromeå½“å‰æ ‡ç­¾é¡µç½‘å€ï¼ˆé€šè¿‡åœ°å€æ æ§ä»¶ï¼‰"""
    address_bar_class = 'Chrome_AutocompleteEditView'
    handles = []
    def enum_child(handle, extra):
        if win32gui.GetClassName(handle) == address_bar_class:
            extra.append(handle)
        win32gui.EnumChildWindows(handle, enum_child, extra)
        return True
    win32gui.EnumChildWindows(hwnd, enum_child, handles)
    return win32gui.GetWindowText(handles[0]).strip() if handles else None

def get_edge_url(hwnd):
    """æå–Edgeå½“å‰æ ‡ç­¾é¡µç½‘å€ï¼ˆé€šè¿‡åœ°å€æ æ§ä»¶ï¼‰"""
    # å…ˆæ‰¾Edgeå­çª—å£
    edge_windows = []
    def find_edge_win(handle, extra):
        if win32gui.GetClassName(handle) == 'MicrosoftEdgeWindowClass':
            extra.append(handle)
        win32gui.EnumChildWindows(handle, find_edge_win, extra)
        return True
    win32gui.EnumChildWindows(hwnd, find_edge_win, edge_windows)
    if not edge_windows:
        return None
    # å†æ‰¾åœ°å€æ 
    addr_bars = []
    def find_addr_bar(handle, extra):
        if win32gui.GetClassName(handle) == 'RichEditBox':
            extra.append(handle)
        win32gui.EnumChildWindows(handle, find_addr_bar, extra)
        return True
    win32gui.EnumChildWindows(edge_windows[0], find_addr_bar, addr_bars)
    return win32gui.GetWindowText(addr_bars[0]).strip() if addr_bars else None

def get_firefox_url(hwnd):
    """æå–Firefoxå½“å‰æ ‡ç­¾é¡µç½‘å€ï¼ˆé€šè¿‡åœ°å€æ æ§ä»¶ï¼‰"""
    addr_bars = []
    def enum_child(handle, extra):
        text = win32gui.GetWindowText(handle).strip()
        if win32gui.GetClassName(handle) == 'Edit' and text.startswith(('http://', 'https://')):
            extra.append(handle)
        win32gui.EnumChildWindows(handle, enum_child, extra)
        return True
    win32gui.EnumChildWindows(hwnd, enum_child, addr_bars)
    return win32gui.GetWindowText(addr_bars[0]).strip() if addr_bars else None

# ====== 4. æ­£ç¡®è¯†åˆ«æµè§ˆå™¨+æå–ç½‘å€/æ ‡é¢˜ ======
def get_active_browser_info():
    hwnd = win32gui.GetForegroundWindow()
    if not hwnd:
        return "about:blank", "æ— æ¿€æ´»çª—å£"
    
    window_title = win32gui.GetWindowText(hwnd)
    if not window_title:
        return "about:blank", "æ— çª—å£æ ‡é¢˜"
    
    # å‡†ç¡®åˆ¤æ–­æµè§ˆå™¨è¿›ç¨‹ï¼ˆä¿®å¤Edge/Chromeè¯†åˆ«ï¼‰
    _, pid = win32process.GetWindowThreadProcessId(hwnd)
    try:
        proc = psutil.Process(pid)
        exe_basename = os.path.basename(proc.exe()).lower()
        # ç›®æ ‡æµè§ˆå™¨è¿›ç¨‹åï¼ˆWindowså®é™…è¿›ç¨‹åï¼‰
        valid_browsers = {
            'chrome.exe': ('chrome', 'Google Chrome'),
            'microsoftedge.exe': ('edge', 'Microsoft Edge'),
            'firefox.exe': ('firefox', 'Mozilla Firefox')
        }
        if exe_basename not in valid_browsers:
            return "about:blank", f"éç›®æ ‡æµè§ˆå™¨ï¼ˆ{exe_basename}ï¼‰"
        browser_type, browser_name = valid_browsers[exe_basename]
    except Exception as e:
        return "about:blank", f"è¿›ç¨‹å¼‚å¸¸ï¼š{str(e)[:50]}"
    
    # æå–å½“å‰ç½‘å€ï¼ˆå¯¹åº”æµè§ˆå™¨ç±»å‹ï¼‰
    url = None
    if browser_type == 'chrome':
        url = get_chrome_url(hwnd)
    elif browser_type == 'edge':
        url = get_edge_url(hwnd)
    elif browser_type == 'firefox':
        url = get_firefox_url(hwnd)
    
    # æå–ç½‘é¡µæ ‡é¢˜ï¼ˆç§»é™¤æµè§ˆå™¨åï¼‰
    if url:
        title = window_title.replace(f' - {browser_name}', '').strip() or "æ— æ ‡é¢˜"
        return url, title
    else:
        return "about:blank", f"æ— æ³•è·å–{browser_name}ç½‘å€"

# ====== 5. ä¸ŠæŠ¥é€»è¾‘ ======
def report_once():
    url, title = get_active_browser_info()
    student_ip = get_student_ip()
    target_ip = get_target_ip(url)
    
    if not url.startswith(('http://', 'https://')) and url != "about:blank":
        print(f"[{time.strftime('%H:%M:%S')}] è·³è¿‡éHTTPæ•°æ®ï¼š{url}")
        return
    
    payload = {
        "student_id": STUDENT_ID,
        "student_ip": student_ip,
        "url": url[:512],
        "title": title[:256],
        "target_ip": target_ip
    }
    
    try:
        resp = requests.post(SERVER_URL, json=payload, timeout=5)
        resp_data = resp.json()
        status = "ğŸ”´é»‘åå•" if resp_data.get('blacklisted') else "ğŸŸ¢æ­£å¸¸"
        print(f"[{time.strftime('%H:%M:%S')}] {STUDENT_ID} | å­¦ç”ŸIP:{student_ip} | {status} | ç½‘å€:{url[:50]} | ç½‘é¡µIP:{target_ip}")
    except Exception as e:
        print(f"[{time.strftime('%H:%M:%S')}] âŒ ä¸ŠæŠ¥å¤±è´¥ï¼š{str(e)} | å­¦ç”ŸIP:{student_ip} | ç½‘å€:{url[:50]}")

# ====== ä¸»å¾ªç¯ ======
if __name__ == '__main__':
    print(f"ğŸ§‘ å­¦ç”Ÿç«¯å¯åŠ¨æˆåŠŸ | å­¦ç”ŸID: {STUDENT_ID} | æ”¯æŒï¼šChrome/Edge/Firefox")
    print("="*80)
    while True:
        report_once()
        time.sleep(REPORT_INTERVAL)